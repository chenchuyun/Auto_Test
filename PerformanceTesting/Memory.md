# 内存相关

## 内存

内存：从操作系统的角度来说，内存就是一块数据存储区域，是可被操作系统调度的资源。

购买Android手机时经常可以看到6G+128GB,8G+256GB这些版本配置，这里面的6G，8G表示是**随机存取存储器**(英语:RandomAccessMemory，缩写:RAM;也叫主存)是**与CPU直接交换数据的内部存储器**。它**可以随时读写，而且速度很快，通常作为操作系统或其他正在运行中的程序的临时资料存储介质**。

## 内存管理

在多任务（进程）的操作系统中，内存管理尤为重要，操作系统需要为每一个进程合理的分配内存资源，所以可以从操作系统对内存分配和回收两方面来理解内存管理机制。

### 分配机制

为每一个任务（进程）分配一个合理大小的内存块，保证每一个进程都能够正常的运行，同时确保进程不会占用太多的内存。

### 回收机制

当系统内存不足的时候，需要有一个合理的回收再分配机制，以保证新的进程可以正常运行。

## Android内存管理机制

Android系统是基于Linux内核开发的开源操作系统，而linux系统的内存管理有其独特的动态存储管理机制。不过Android系统对Linux的内存管理机制进行了优化，**Linux系统会在进程活动停止后就结束该进程，而Android把这些进程都保留在内存中**，直到系统需要更多内存为止。**这些保留在内存中的进程通常情况下不会影响整体系统的运行速度，并且当用户再次激活这些进程时，提升了进程的启动速度**。

## Android内存分配机制

1、Android为每个进程分配内存的时候，采用了弹性的分配方式，也就是**刚开始并不会一下分配很多内存给每个进程，而是给每一个进程分配一个“够用”的量**。这个量是**根据每一个设备实际的物理内存大小来决定**的。

2、随着应用的运行，可能会发现当前的内存可能不够使用了，这时候Android又会为每个进程分配一些额外的内存大小。但是这些额外的大小并不是随意的，也是有限度的，系统不可能为每一个App分配无限大小的内存。

3、**Android系统的宗旨是最大限度的让更多的进程存活在内存中**，因为这样的话，下一次用户再启动应用，不需要重新创建进程，只需要恢复已有的进程就可以了，减少了应用的启动时间，提高了用户体验。

## Android内存回收机制

1、Android对内存的使用方式是“尽最大限度的使用”，这一点继承了Linux的优点。Android会在内存中保存尽可能多的数据，即使有些进程不再使用了，但是它的数据还被存储在内存中，所以Android现在不推荐显式的“退出”应用。

2、因为这样，当用户下次再启动应用的时候，只需要恢复当前进程就可以了，不需要重新创建进程这样就可以减少应用的启动时间。只有当Android系统发现内存不够使用，需要回收内存的时候，Android系统就会需要杀死其他进程，来回收足够的内存。但是Android也不是随便杀死一个进程比如说一个正在与用户交互的进程，这种后果是可怕的。所以Android会有限的清理那些已经不再使用的进程，以保证最小的副作用。

## Linux回收机制

在Linux里面，一个进程占用的内存有不同种说法，有四种形式:

VSS-VirtualSetSize虚拟耗用内存

RSS-ResidentSetSize实际使用物理内存

PSS-ProportionalSetSize按比例使用的物理内存

USS-UniqueSetSize进程独自占用的物理内存

1、VSS是单个进程全部可访问的地址空间，其大小可能包括还尚未在内存中驻留的部分。对于确定单个进程实际内存使用大小，VSS用处不大。

2、RSS是单个进程实际占用的内存大小，RSS不太准确的地方在于它包括该进程所使用共享库全部内存大小。对于一个共享库，可能被多个进程使用，实际该共享库只会被装入内存一次。

3、PSS不同于RSS，它只是按比例包含其所使用的共享库大小。**PSS相对于RSS计算共享库内存大小是按比例的**。例如:3个进程使用同一个占用30个内存页的共享库。对于三个进程中的任何一个，PSS将只包括10个内存页。PSS是一个非常有用的数字，因为系统中全部进程以整体的方式被统计，对于系统中的整体内存使用是比较准确的统计。

4、USS是单个进程私有的内存大小，即该进程独占的内存部分。USS揭示了运行一个特定进程在的真实内存增量大小。如果进程终止，USS就是实际被返还给系统的内存大小。

一般来说内存占用大小有如下规律:

VSS>=RSS>=PSS>=USS

**实际在统计查看某个进程内存占用情况的时候，看PSS是比较客观的Android内存测试获取设备内存信息**

## Android内存测试

### 第一步 获取设备内存信息

在Linux操作系统中，**/pro**c是一个位于内存中的伪文件系统(in-memorypseudo-filesystem)。**该目录下保存的不是真正的文件和目录而是一些运行时信息**，如系统内存、磁盘i0、设备挂载信息和硬件配置信息等。

### 第二步 查看设备整体内存使用情况的方法

在cmd或powshell窗口使用命令

>adb shell cat /proc/meminfo

![image](https://github.com/user-attachments/assets/bc596e49-7736-44f7-9062-659aca599fca)

MenTotal--总共可用内存

MemFree--空闲内存

MemAvailable--已用内存

### 第三步 获取设备各个应用的VSS、RSS、PSS、USS

在cmd或powshell窗口使用命令

>adb shell procrank

![image](https://github.com/user-attachments/assets/ad9e5772-face-4a10-9f90-faae156f25f6)

### 第四步 获取指定包的内存占用情况

在cmd或powshell窗口使用命令

>adb shell dumpsys meminfo [pkg or pid]

## 自动化获取性能数据

前面我们使用adb命令获取CPU，内存性能数据；

如果想批量获取性能数据，使用命令一个个查询会非常的不方便，我们可以使用Python自动化代码来自动获取性能数据。

自动化代码见Monitoring.py文件
